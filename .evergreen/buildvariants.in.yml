buildvariants:
  - name: connectivity-tests

    display_name: Connectivity Tests
    run_on: ubuntu2004-large
    tasks:
      - name: test-connectivity

  - name: generate-vulnerability-report
    display_name: Vulnerability Report
    run_on: ubuntu2004-large
    tasks:
      - name: generate-vulnerability-report

  - name: coverage
    display_name: E2E Coverage
    run_on: ubuntu2004-large
    tasks:
      - name: e2e-coverage

  - name: csfle-tests
    display_name: CSFLE Tests
    run_on: ubuntu2004-large
    tasks:
      - name: test-csfle

  - name: test-web-sandbox
    display_name: Test Web Sandbox
    run_on: ubuntu2004-large
    tasks:
      - name: test-web-sandbox-chrome
      - name: test-web-sandbox-firefox

<%
const testAndPackageBuildVariants = [
  {
    name: 'test-and-package-ubuntu',
    display_name: 'Ubuntu 16.04',
    run_on: 'ubuntu1604-large',
  },
  {
    name: 'test-and-package-windows',
    display_name: 'Windows 10',
    run_on: 'windows-vsCurrent-large',
  },
  {
    name: 'test-and-package-rhel',
    display_name: 'RHEL 8.0',
    run_on: 'rhel80-large',
  },
  {
    name: 'test-and-package-macos-x64',
    display_name: 'MacOS x64 11',
    run_on: 'macos-1100',
    run_on_gui: 'macos-1100-gui'
  },
  {
    name: 'test-and-package-macos-arm',
    display_name: 'MacOS arm64 11',
    run_on: 'macos-1100-arm64',
    run_on_gui: 'macos-1100-arm64-gui'
  }
];

for (const buildVariant of testAndPackageBuildVariants) { %>
  - name: <%= buildVariant.name %>

    display_name: <%= buildVariant.display_name %> (Test and Package)
    run_on: <%= buildVariant.run_on %>
    tasks:
    - name: check
    - name: test
    - name: test-electron
      <% if (buildVariant.run_on_gui) { %>
      run_on: <%= buildVariant.run_on_gui %>
      <% } %>
    - name: package-compass
    - name: package-compass-readonly
    - name: package-compass-isolated
<% } %>

<%
const testPackagedAppBuildVariants = [
  {
    name: 'test-packaged-app-ubuntu',
    display_name: 'Ubuntu 20.04',
    run_on: 'ubuntu1604-large',
    depends_on: 'test-and-package-ubuntu',
    test_latest_alpha: true,
    test_eol_servers: true
  },
  {
    name: 'test-packaged-app-windows',
    display_name: 'Windows 10',
    run_on: 'windows-vsCurrent-large',
    depends_on: 'test-and-package-windows',
    test_latest_alpha: true,
    test_eol_servers: true
  },
  {
    name: 'test-packaged-app-rhel',
    display_name: 'RHEL 8.0',
    run_on: 'rhel80-large',
    depends_on: 'test-and-package-rhel',
    test_eol_servers: true
  },
  {
    name: 'test-packaged-app-macos-11-x64',
    display_name: 'MacOS x64 11',
    run_on: 'macos-1100-gui',
    patchable: false,
    depends_on: 'test-and-package-macos-x64'
  },
  {
    name: 'test-packaged-app-macos-11-arm',
    display_name: 'MacOS arm64 11',
    run_on: 'macos-1100-arm64-gui',
    patchable: false,
    depends_on: 'test-and-package-macos-arm'
  },
  {
    name: 'test-packaged-app-macos-14-x64',
    display_name: 'MacOS x64 14',
    run_on: 'macos-14-gui',
    patchable: false,
    depends_on: 'test-and-package-macos-x64'
  },
  {
    name: 'test-packaged-app-macos-14-arm',
    display_name: 'MacOS arm64 14',
    run_on: 'macos-14-arm64-gui',
    depends_on: 'test-and-package-macos-arm'
  },
];

for (const buildVariant of testPackagedAppBuildVariants) { %>
  - name: <%= buildVariant.name %>
    display_name: <%= buildVariant.display_name %> (Test Packaged App)
    run_on: <%= buildVariant.run_on %>
    patchable: <%= buildVariant.patchable ?? true %>
    depends_on:
      - name: package-compass
        variant: <%= buildVariant.depends_on %>
    tasks:
       <% if (buildVariant.test_eol_servers) { %>
      - name: test-packaged-app-40x-community
      - name: test-packaged-app-40x-enterprise
      - name: test-packaged-app-42x-community
      - name: test-packaged-app-42x-enterprise
      - name: test-packaged-app-44x-community
      - name: test-packaged-app-44x-enterprise
      - name: test-packaged-app-5x-community
      - name: test-packaged-app-5x-enterprise
      <% } %>
      - name: test-packaged-app-60x-community
      - name: test-packaged-app-60x-enterprise
      - name: test-packaged-app-70x-community
      - name: test-packaged-app-70x-enterprise
      - name: test-packaged-app-80x-community
      - name: test-packaged-app-80x-enterprise
      <% if (buildVariant.test_latest_alpha) { %>
      - name: test-packaged-app-latest-alpha
      <% } %>
<% } %>

  - name: publish
    display_name: Publish Artifacts
    run_on: ubuntu2004-large
    tasks:
      - name: publish
      - name: publish-packages-next
      - name: publish-dev-release-info
