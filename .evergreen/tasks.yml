tasks:
  - name: check
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
      - func: check

  - name: test
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
      - func: test
        vars:
          debug: 'hadron*,mongo*'

  - name: test-electron
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
      - func: test-electron
        vars:
          debug: 'hadron*,mongo*'

  - name: test-connectivity
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: clone
      - func: test-connectivity
        vars:
          debug: 'compass*,electron*,hadron*,mongo*'

  - name: test-csfle
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
      - func: test-csfle
        vars:
          debug: 'compass*,electron*,hadron*,mongo*'

  - name: e2e-coverage
    tags: ['run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
      - func: e2e-coverage
        vars:
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: e2e-multiple-connections
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: compass-e2e-tests
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-multiple-connections
        vars:
          mongodb_version: latest-alpha-enterprise
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: generate-vulnerability-report
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
      - func: generate-vulnerability-report
        vars:
          debug: 'compass*,electron*,hadron*,mongo*'

  # Publish happens in one go to make sure we are not creating multiple github
  # releases in parallel
  - name: publish
    # Does a dry-run: doesn't actually publishes, but checks that all files
    # exist and we are not trying to do a "broken" publish
    tags: ['run-on-pr']
    depends_on:
      - name: '.required-for-publish'
        variant: '*'
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: mongodb-compass
      - func: get-all-artifacts
      - func: publish

  - name: publish-packages-next
    tags: []
    depends_on:
      - name: '.required-for-publish'
        variant: '*'
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
      - func: publish-packages-next
  - name: publish-dev-release-info
    tags: []
    depends_on:
      - name: 'publish'
        variant: '*'
    commands:
      - func: prepare
      - func: publish-dev-release-info


  - name: package-compass
    tags: ['required-for-publish', 'run-on-pr', 'package-task']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: '@mongodb-js/webpack-config-compass'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: spawn-signing-server
      - func: package
        vars:
          debug: 'hadron*,mongo*,compass*,electron*,sign*'
          compass_distribution: compass
      - func: verify-artifacts
      - func: save-all-artifacts
        vars:
          compass_distribution: compass

  - name: package-compass-readonly
    tags: ['required-for-publish', 'run-on-pr', 'package-task']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: '@mongodb-js/webpack-config-compass'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass-readonly
      - func: spawn-signing-server
      - func: package
        vars:
          debug: 'hadron*,mongo*,compass*,electron*,sign*'
          compass_distribution: compass-readonly
      - func: verify-artifacts
      - func: save-all-artifacts
        vars:
          compass_distribution: compass-readonly

  - name: package-compass-isolated
    tags: ['required-for-publish', 'run-on-pr', 'package-task']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: '@mongodb-js/webpack-config-compass'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass-isolated
      - func: spawn-signing-server
      - func: package
        vars:
          debug: 'hadron*,mongo*,compass*,electron*,sign*'
          compass_distribution: compass-isolated
      - func: verify-artifacts
      - func: save-all-artifacts
        vars:
          compass_distribution: compass-isolated


  - name: test-packaged-app-40x-community
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-packaged-app
        vars: 
          mongodb_version: '4.0.x'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: test-packaged-app-40x-enterprise
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-packaged-app
        vars: 
          mongodb_version: '4.0.x-enterprise'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: test-packaged-app-42x-community
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-packaged-app
        vars: 
          mongodb_version: '4.2.x'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: test-packaged-app-42x-enterprise
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-packaged-app
        vars: 
          mongodb_version: '4.2.x-enterprise'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: test-packaged-app-44x-community
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-packaged-app
        vars: 
          mongodb_version: '4.4.x'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: test-packaged-app-44x-enterprise
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-packaged-app
        vars: 
          mongodb_version: '4.4.x-enterprise'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: test-packaged-app-5x-community
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-packaged-app
        vars: 
          mongodb_version: '5.x.x'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: test-packaged-app-5x-enterprise
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-packaged-app
        vars: 
          mongodb_version: '5.x.x-enterprise'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: test-packaged-app-60x-community
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-packaged-app
        vars: 
          mongodb_version: '6.0.x'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: test-packaged-app-60x-enterprise
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-packaged-app
        vars: 
          mongodb_version: '6.0.x-enterprise'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: test-packaged-app-70x-community
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-packaged-app
        vars: 
          mongodb_version: '7.0.x'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: test-packaged-app-70x-enterprise
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-packaged-app
        vars: 
          mongodb_version: '7.0.x-enterprise'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: test-packaged-app-80x-community
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-packaged-app
        vars: 
          mongodb_version: '>= 8.0.0-rc4'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: test-packaged-app-80x-enterprise
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-packaged-app
        vars: 
          mongodb_version: '>= 8.0.0-rc4-enterprise'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: test-packaged-app-latest
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: get-packaged-app
        vars:
          compass_distribution: compass
      - func: test-packaged-app
        vars: 
          mongodb_version: 'latest-alpha-enterprise'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'


  - name: test-web-sandbox-chrome
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: test-web-sandbox
        vars: 
          mongodb_version: 'latest-alpha-enterprise'
          browser_name: 'chrome'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: test-web-sandbox-firefox
    tags: ['required-for-publish', 'run-on-pr']
    commands:
      - func: prepare
      - func: install
      - func: bootstrap
        vars:
          scope: 'compass-e2e-tests'
      - func: apply-compass-target-expansion
        vars:
          compass_distribution: compass
      - func: test-web-sandbox
        vars: 
          mongodb_version: 'latest-alpha-enterprise'
          browser_name: 'firefox'
          compass_distribution: compass
          debug: 'compass-e2e-tests*,electron*,hadron*,mongo*'

  - name: create_static_analysis_report
    tags: ['required-for-publish', 'run-on-pr']
    depends_on:
      - name: ".package-task"
        variant: "*"
    commands:
      - func: prepare
      - func: install

      - func: get_first_party_dependency_list
        vars:
          filename: first-party-deps-compass-ubuntu.json

      - func: get_first_party_dependency_list
        vars:
          filename: first-party-deps-compass-windows.json

      - func: get_first_party_dependency_list
        vars:
          filename: first-party-deps-compass-macos.json

      - func: get_first_party_dependency_list
        vars:
          filename: first-party-deps-compass-macos-arm.json

      - func: get_first_party_dependency_list
        vars:
          filename: first-party-deps-compass-readonly-ubuntu.json

      - func: get_first_party_dependency_list
        vars:
          filename: first-party-deps-compass-readonly-windows.json

      - func: get_first_party_dependency_list
        vars:
          filename: first-party-deps-compass-readonly-macos.json

      - func: get_first_party_dependency_list
        vars:
          filename: first-party-deps-compass-readonly-macos-arm.json

      - func: get_first_party_dependency_list
        vars:
          filename: first-party-deps-compass-isolated-ubuntu.json

      - func: get_first_party_dependency_list
        vars:
          filename: first-party-deps-compass-isolated-windows.json

      - func: get_first_party_dependency_list
        vars:
          filename: first-party-deps-compass-isolated-macos.json

      - func: get_first_party_dependency_list
        vars:
          filename: first-party-deps-compass-isolated-macos-arm.json

      - func: create_static_analysis_report
        vars:
          first_party_dependency_filenames: .sbom/first-party-deps-compass-ubuntu.json,.sbom/first-party-deps-compass-windows.json,.sbom/first-party-deps-compass-macos.json,.sbom/first-party-deps-compass-macos-arm.json,.sbom/first-party-deps-compass-readonly-ubuntu.json,.sbom/first-party-deps-compass-readonly-windows.json,.sbom/first-party-deps-compass-readonly-macos.json,.sbom/first-party-deps-compass-readonly-macos-arm.json,.sbom/first-party-deps-compass-isolated-ubuntu.json,.sbom/first-party-deps-compass-isolated-windows.json,.sbom/first-party-deps-compass-isolated-macos.json,.sbom/first-party-deps-compass-isolated-macos-arm.json
